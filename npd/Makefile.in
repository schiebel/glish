# $Header$
#
# Makefile for npd C libraries.

CC = @CC@
CFLAGS = @CFLAGS@
RANLIB = @RANLIB@
INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
INSTALL_PROGRAM = @INSTALL_PROGRAM@

MKHIER = @top_srcdir@/config/mkhier

SHELL = /bin/sh

RM = rm -f

SRC = ..
HEADERDIR = $(SRC)/include/Npd
INC = -I. -I$(SRC)/include -I/usr/ucbinclude

INSTALLDIR = @top_srcdir@
INCDIR = $(INSTALLDIR)/include
LIBDIR = $(INSTALLDIR)/lib/$(ARCH)
BINDIR = $(INSTALLDIR)/bin/$(ARCH)

##
## prefix may be used as part of '@exec_prefix@'
##
prefix = @prefix@
PFX_INSTALLDIR = @exec_prefix@
PFX_INCDIR = @prefix@/include
PFX_LIBDIR = $(PFX_INSTALLDIR)/lib
PFX_BINDIR = $(PFX_INSTALLDIR)/bin

KEYDIR = @KEYDIR@
##LOGDIR = /net/kochab/kochab_3/dschieb/glish/glish/log

OBJS = auth.o \
	md5c.o \
	npd.o \
	util.o

SINC = $(HEADERDIR)/auth.h \
	$(HEADERDIR)/md5.h \
	$(HEADERDIR)/util.h \
	$(HEADERDIR)/npd.h

TAR_FILE = npd.tar

libs: libnpd.a glishkey

libnpd.a: $(OBJS)
	$(RM) libnpd.a
	ar cru libnpd.a $(OBJS)
	$(RANLIB) libnpd.a

glishkey: libnpd.a genkey.o
	$(CC) $(CFLAGS) $(INC) -o glishkey genkey.o libnpd.a -lm @LIBS@

$(LIBDIR)/libnpd.a:libnpd.a
	$(MKHIER) $(LIBDIR)
	$(INSTALL_DATA) libnpd.a $(LIBDIR)
	$(RANLIB) $(LIBDIR)/libnpd.a

$(BINDIR)/glishkey:glishkey
	$(MKHIER) $(BINDIR)
	$(INSTALL_PROGRAM) -s glishkey $(BINDIR)

install: $(LIBDIR)/libnpd.a $(BINDIR)/glishkey
	$(MKHIER) $(INCDIR)/Npd
	@rm -f $(INCDIR)/Npd/*.h
	cp $(SINC) $(INCDIR)/Npd

$(PFX_LIBDIR)/libnpd.a:libnpd.a
	$(MKHIER) $(PFX_LIBDIR)
	$(INSTALL_DATA) libnpd.a $(PFX_LIBDIR)
	$(RANLIB) $(PFX_LIBDIR)/libnpd.a

$(PFX_BINDIR)/glishkey:glishkey
	$(MKHIER) $(PFX_BINDIR)
	$(INSTALL_PROGRAM) -s glishkey $(PFX_BINDIR)

prefix-install: $(PFX_LIBDIR)/libnpd.a $(PFX_BINDIR)/glishkey
	$(MKHIER) $(PFX_INCDIR)/Npd
	@rm -f $(PFX_INCDIR)/Npd/*.h
	cp $(SINC) $(PFX_INCDIR)/Npd

tar:
	@rm -f $(TAR_FILE).Z tar-files
	@$(MAKE) $(MFLAGS) tar-list >tar-files
	tar cf $(TAR_FILE) -I tar-files
	compress $(TAR_FILE)
	@rm -f tar-files

tar-list:
	@echo npd >&2
	@ls Makefile.in *.c include/Npd/*.h

rcsinfo:
	@echo sds
	@rlog -L RCS/*,v | sed -n -e 's/Working file://p' -e 's/locked by//p'
	@echo sds/include/Sds
	@cd include/Sds;rlog -L RCS/*,v | sed -n -e 's/Working file://p' -e 's/locked by//p'

clean:
	@rm -f errs *.o *~* $(APPS) core a.out *.a ../$(TAR_FILE).Z

distclean: clean
	rm -f config.status config.cache config.h Makefile

auth.o: $(SRC)/auth.c $(HEADERDIR)/md5.h $(HEADERDIR)/util.h $(HEADERDIR)/auth.h
	$(CC) $(CFLAGS) $(INC) -c $(SRC)/auth.c

npd.o: $(SRC)/npd.c $(SRC)/version.h $(HEADERDIR)/auth.h $(HEADERDIR)/util.h
	$(CC) $(CFLAGS) -DKEYS_DIR=\"$(KEYDIR)\" $(INC) -c $(SRC)/npd.c

md5c.o: $(SRC)/md5c.c $(HEADERDIR)/md5.h
	$(CC) $(CFLAGS) $(INC) -c $(SRC)/md5c.c

util.o: $(SRC)/util.c $(HEADERDIR)/util.h
	$(CC) $(CFLAGS) $(INC) -c $(SRC)/util.c
#	$(CC) $(CFLAGS) -DLOG_FMT=\"$(LOGDIR)/%s.%s@%s.log\" $(INC) -c $(SRC)/util.c

genkey.o: $(SRC)/genkey.c $(HEADERDIR)/util.h
	$(CC) $(CFLAGS) $(INC) -c $(SRC)/genkey.c
